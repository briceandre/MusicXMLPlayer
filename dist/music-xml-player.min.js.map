{"version":3,"sources":["webpack://MusicXMLPlayer/webpack/universalModuleDefinition","webpack://MusicXMLPlayer/./src/MusicXMLPlayer.ts","webpack://MusicXMLPlayer/./src/Synthetizer.ts","webpack://MusicXMLPlayer/webpack/bootstrap","webpack://MusicXMLPlayer/webpack/startup"],"names":["root","factory","exports","module","define","amd","a","i","self","console","log","mxl","sample_base_url","this","synth","Synthetizer","data","tempo","is_cleaned_up","is_playing","is_loaded","playing_info","next_measure_to_send","selected_instruments","selected_replayed_instruments","on_cyclic_callback","setInterval","OnCyclic","bind","on_play_measure","on_stop","onLoadPromise","Promise","OnLoadPromiseInitialised","resolve","onLoadPromiseResolve","waitReady","loadNotes","clearInterval","cleanup","voice_id","instrument_id","volume","instruments","callback","loadInstruments","getNotes","push","name","parseInt","tmp","getInstruments","length","ClearAll","OnInstrumentsLoded","AddReplayedInstrument","then","r","t","start","resetPlayingInfo","measure_id","stop","pitch","note_symbol","step","alter","octave","voice","instrument","note_data","measure","current_note_start","last_note_duration","notes_to_stop","playing_notes","remaining_notes_to_stop","note_to_stop","shall_keep","entry","type","ComputeNoteSymbol","tie","ReleaseNote","current_note_duration","duration","measures_attributes","beat_type","division","shall_start","shall_stop","chord","is_start","includes","splice","indexOf","TriggerNote","attributes","attribute","divisions","time","beats","voices","measure_duration","PlayVoice","id","d","PlayInstrument","part","measure_start_time","setFeededWithDuration","measure_played","setTimeout","TriggerOnMeasure","now","notes","note","checkShallFeed","PlayMeasure","extractXML","xml","attributes_filter","array_nodes","children_filter","json_data","xmlToJson","node_parent","obj","nodeType","j","item","nodeName","nodeValue","textNodes","slice","call","childNodes","filter","node","hasChildNodes","reduce","text","children","export_name","value","old","DOMParser","parseFromString","OnNotesLoaded","zip","main_file","getElementsByTagName","getAttribute","file","async","OnXMLExtracted","OnXMLManifestLoaded","JSZip","loadAsync","OnXMLLoaded","midiInstrumentsNames","worker_path","scripts","document","src","substring","endsWith","lastIndexOf","is_cleanup","note_parser","NoteParser","context","window","AudioContext","webkitAudioContext","playing","shall_feed","last_sent_finish_time","periodic_function","onCyclic","in_sending","feeded","last_promise_id","promises","worker","Worker","OnWorkerInitialised","terminate","close","onmessage","ManageWorkerMessage","e","hasOwnProperty","promise","result","used_notes","Error","instruments_to_load","instruments_url","requirejs","OnLoadInstruments","MIDI","parsed","filtered_notes","Object","keys","convert","Soundfont","OnLoadNote","all","AddReplayedInstrumentToWorker","ClearAllToWorker","replayed_instrument","SetReplayedInstrumentVolumeToWorker","SetReplayedInstrumentInstrumentToWorker","offset","TriggerNoteToWorker","Math","floor","sampleRate","ReleaseNoteToWorker","ReleaseAllNotes","currentTime","send_next_sample","args","InvokeWorkerCommandPromise","postMessage","sample_rate","channel_1_data","channel_2_data","load_note_Promise","invokeWorkerCommand","base64","binary_string","atob","len","bytes","Uint8Array","charCodeAt","buffer","channel_1","getChannelData","channel_2","channel_1_buffer","ArrayBuffer","channel_2_buffer","channel_1_buffer_view","Float32Array","channel_2_buffer_view","internal_load_note","b64_data","decodeAudioData","base64ToArrayBuffer","LoadNote","OnDecodeNote","nb_samples","load_note","SampleDataToWorker","data_buffer_1","data_buffer_2","createBuffer","b1","b2","source","createBufferSource","connect","destination","SampleData","SendDataToSoundCard","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__"],"mappings":"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C5B,CACG,IAAIkG,EAAMlB,EAAII,GACdJ,EAAIgB,GAAe,GACnBhB,EAAIgB,GAAahG,KAAKkG,GAGzBlB,EAAIgB,GAAahG,KAAKiG,KAKlC,OAAOjB,EAIMF,EAAU,IAAIqB,WAAYC,gBAAgB3B,EAAK,YAAa,QAG5E3G,KAAKuI,cAAcxB,GAGd,oBAAoByB,EAAUrI,GAGnC,IAAIsI,GAAY,IAAKJ,WAAaC,gBAAgBnI,EAAM,YAAYuI,qBAAqB,YAAY,GAAGC,aAAa,aAGrHH,EAAII,KAAKH,GAAWI,MAAM,UAAUlG,KAAK3C,KAAK8I,eAAe/H,KAAKf,OAG7D,YAAYwI,GAEjBA,EAAII,KAAK,0BAA0BC,MAAM,UAAUlG,KAAK3C,KAAK+I,oBAAoBhI,KAAKf,KAAMwI,IAGvF,WAAW1I,IAGR,IAAIkJ,OACVC,UAAUnJ,GAAK6C,KAAK3C,KAAKkJ,YAAYnI,KAAKf,U,iFC1wBlD,oBA0BG,YAAYD,EAAwB,2DAqS5B,KAAAoJ,qBACL,CAAC,uBACA,wBACA,uBACA,kBACA,mBACA,mBACA,cACA,WACA,UACA,eACA,YACA,aACA,UACA,YACA,gBACA,WACA,gBACA,mBACA,aACA,eACA,aACA,YACA,YACA,kBACA,wBACA,wBACA,uBACA,wBACA,wBACA,oBACA,oBACA,mBACA,gBACA,uBACA,qBACA,gBACA,cACA,cACA,eACA,eACA,SACA,QACA,QACA,aACA,kBACA,oBACA,kBACA,UACA,oBACA,oBACA,kBACA,kBACA,aACA,aACA,cACA,gBACA,UACA,WACA,OACA,gBACA,cACA,gBACA,gBACA,gBACA,cACA,WACA,YACA,eACA,OACA,eACA,UACA,WACA,UACA,QACA,WACA,YACA,eACA,aACA,UACA,UACA,gBACA,kBACA,kBACA,eACA,iBACA,eACA,gBACA,kBACA,gBACA,aACA,kBACA,cACA,cACA,iBACA,aACA,cACA,YACA,kBACA,eACA,kBACA,kBACA,eACA,cACA,aACA,QACA,QACA,WACA,OACA,UACA,UACA,SACA,SACA,cACA,QACA,cACA,YACA,aACA,cACA,aACA,iB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","file":"music-xml-player.min.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse {\n\t\tvar a = factory();\n\t\tfor(var i in a) (typeof exports === 'object' ? exports : root)[i] = a[i];\n\t}\n})(self, function() {\nreturn ","import {Synthetizer} from './Synthetizer.ts';\r\n\r\ndeclare class JSZip \r\n{\r\n  constructor();\r\n  loadAsync(arg: string): any;\r\n}\r\n\r\nconsole.log('loading MusicXMLPlayer')\r\nexport class MusicXMLPlayer\r\n{\r\n   private synth: Synthetizer;\r\n   private data: any;\r\n   \r\n   private tempo: number;\r\n   \r\n   private is_cleaned_up: boolean;\r\n   \r\n   private is_playing: boolean;\r\n   private is_loaded: boolean;\r\n   private playing_info: {measures_attributes: {division: number, beats: number, beat_type: number},\r\n                           playing_notes: {[index: number]:string[]}}[];\r\n   private next_measure_to_send: number;\r\n   \r\n   private on_cyclic_callback: number;\r\n   \r\n   private selected_instruments: number[];\r\n   private selected_replayed_instruments: number[];\r\n   \r\n   private on_play_measure: (arg0: number) => void;\r\n   private on_stop: () => void;\r\n   \r\n   private onLoadPromise: Promise<void>;\r\n   private onLoadPromiseResolve: any;\r\n   \r\n   constructor(mxl: string, sample_base_url: string=\"https://gleitz.github.io/midi-js-soundfonts/MusyngKite/\")\r\n   {\r\n      this.synth = new Synthetizer(sample_base_url);\r\n      this.data = false; \r\n\r\n      this.tempo = 80;\r\n      \r\n      this.is_cleaned_up = false;\r\n      \r\n      this.is_playing = false;\r\n      this.is_loaded = false;\r\n      this.playing_info = [];\r\n      this.next_measure_to_send = 0;\r\n      \r\n      this.selected_instruments = [];\r\n      this.selected_replayed_instruments = [];\r\n      \r\n      this.on_cyclic_callback = setInterval(this.OnCyclic.bind(this), 100);\r\n      \r\n      this.on_play_measure = function(a: number){}\r\n      this.on_stop = function() {}\r\n\r\n      this.onLoadPromise = new Promise(this.OnLoadPromiseInitialised.bind(this, mxl));\r\n   }\r\n   \r\n   private OnLoadPromiseInitialised(mxl: string, resolve: () => void): void\r\n   {\r\n      this.onLoadPromiseResolve = resolve;\r\n      this.synth.waitReady(this.loadNotes.bind(this, mxl))\r\n   }\r\n   \r\n   cleanup(): void\r\n   {\r\n      if (!this.is_cleaned_up)\r\n      {\r\n         this.is_cleaned_up = true;\r\n         \r\n         clearInterval(this.on_cyclic_callback);\r\n         \r\n         this.is_loaded = false;\r\n         this.is_playing = false;\r\n         this.playing_info = [];\r\n         this.next_measure_to_send = 0;\r\n\r\n         this.on_play_measure = function(a: number){}\r\n         this.on_stop = function() {}\r\n         \r\n         this.synth.cleanup();\r\n      }\r\n   }\r\n   \r\n   waitReady(): Promise<void>\r\n   {\r\n      return this.onLoadPromise;\r\n   }\r\n   \r\n   static getAvailableInstruments(): string[]\r\n   {\r\n      return [\"Acoustic Grand Piano\",\r\n              \"Bright Acoustic Piano\",\r\n              \"Electric Grand Piano\",\r\n              \"Honky-tonk Piano\",\r\n              \"Electric Piano 1\",\r\n              \"Electric Piano 2\",\r\n              \"Harpsichord\",\r\n              \"Clavi\",\r\n              \"Celesta\",\r\n              \"Glockenspiel\",\r\n              \"Music Box\",\r\n              \"Vibraphone\",\r\n              \"Marimba\",\r\n              \"Xylophone\",\r\n              \"Tubular Bells\",\r\n              \"Dulcimer\",\r\n              \"Drawbar Organ\",\r\n              \"Percussive Organ\",\r\n              \"Rock Organ\",\r\n              \"Church Organ\",\r\n              \"Reed Organ\",\r\n              \"Accordion\",\r\n              \"Harmonica\",\r\n              \"Tango Accordion\",\r\n              \"Acoustic Guitar (nylon)\",\r\n              \"Acoustic Guitar (steel)\",\r\n              \"Electric Guitar (jazz)\",\r\n              \"Electric Guitar (clean)\",\r\n              \"Electric Guitar (muted)\",\r\n              \"Overdriven Guitar\",\r\n              \"Distortion Guitar\",\r\n              \"Guitar harmonics\",\r\n              \"Acoustic Bass\",\r\n              \"Electric Bass (finger)\",\r\n              \"Electric Bass (pick)\",\r\n              \"Fretless Bass\",\r\n              \"Slap Bass 1\",\r\n              \"Slap Bass 2\",\r\n              \"this.synth Bass 1\",\r\n              \"this.synth Bass 2\",\r\n              \"Violin\",\r\n              \"Viola\",\r\n              \"Cello\",\r\n              \"Contrabass\",\r\n              \"Tremolo Strings\",\r\n              \"Pizzicato Strings\",\r\n              \"Orchestral Harp\",\r\n              \"Timpani\",\r\n              \"String Ensemble 1\",\r\n              \"String Ensemble 2\",\r\n              \"this.synthStrings 1\",\r\n              \"this.synthStrings 2\",\r\n              \"Choir Aahs\",\r\n              \"Voice Oohs\",\r\n              \"this.synth Choir\",\r\n              \"Orchestra Hit\",\r\n              \"Trumpet\",\r\n              \"Trombone\",\r\n              \"Tuba\",\r\n              \"Muted Trumpet\",\r\n              \"French Horn\",\r\n              \"Brass Section\",\r\n              \"this.synthBrass 1\",\r\n              \"this.synthBrass 2\",\r\n              \"Soprano Sax\",\r\n              \"Alto Sax\",\r\n              \"Tenor Sax\",\r\n              \"Baritone Sax\",\r\n              \"Oboe\",\r\n              \"English Horn\",\r\n              \"Bassoon\",\r\n              \"Clarinet\",\r\n              \"Piccolo\",\r\n              \"Flute\",\r\n              \"Recorder\",\r\n              \"Pan Flute\",\r\n              \"Blown Bottle\",\r\n              \"Shakuhachi\",\r\n              \"Whistle\",\r\n              \"Ocarina\",\r\n              \"Lead 1 (square)\",\r\n              \"Lead 2 (sawtooth)\",\r\n              \"Lead 3 (calliope)\",\r\n              \"Lead 4 (chiff)\",\r\n              \"Lead 5 (charang)\",\r\n              \"Lead 6 (voice)\",\r\n              \"Lead 7 (fifths)\",\r\n              \"Lead 8 (bass + lead)\",\r\n              \"Pad 1 (new age)\",\r\n              \"Pad 2 (warm)\",\r\n              \"Pad 3 (polythis.synth)\",\r\n              \"Pad 4 (choir)\",\r\n              \"Pad 5 (bowed)\",\r\n              \"Pad 6 (metallic)\",\r\n              \"Pad 7 (halo)\",\r\n              \"Pad 8 (sweep)\",\r\n              \"FX 1 (rain)\",\r\n              \"FX 2 (soundtrack)\",\r\n              \"FX 3 (crystal)\",\r\n              \"FX 4 (atmosphere)\",\r\n              \"FX 5 (brightness)\",\r\n              \"FX 6 (goblins)\",\r\n              \"FX 7 (echoes)\",\r\n              \"FX 8 (sci-fi)\",\r\n              \"Sitar\",\r\n              \"Banjo\",\r\n              \"Shamisen\",\r\n              \"Koto\",\r\n              \"Kalimba\",\r\n              \"Bag pipe\",\r\n              \"Fiddle\",\r\n              \"Shanai\",\r\n              \"Tinkle Bell\",\r\n              \"Agogo\",\r\n              \"Steel Drums\",\r\n              \"Woodblock\",\r\n              \"Taiko Drum\",\r\n              \"Melodic Tom\",\r\n              \"this.synth Drum\",\r\n              \"Reverse Cymbal\",\r\n              \"Guitar Fret Noise\",\r\n              \"Breath Noise\",\r\n              \"Seashore\",\r\n              \"Bird Tweet\",\r\n              \"Telephone Ring\",\r\n              \"Helicopter\",\r\n              \"Applause\",\r\n              \"Gunshot\"]\r\n   }\r\n\r\n   setReplayInstrument(voice_id: number, instrument_id: number): void\r\n   {\r\n      //TODO\r\n   }\r\n   \r\n   setReplayVolume(voice_id: number, volume: number): void\r\n   {\r\n      //TODO\r\n   }\r\n   \r\n   private loadInstruments(instruments: number[], callback: () => void): void\r\n   {\r\n      /* Extract notes needed */\r\n      this.synth.loadInstruments(instruments, this.getNotes(), callback)\r\n   }\r\n   \r\n   getInstruments(): {name: string, instrument_id: number}[]\r\n   {\r\n      var instruments = []\r\n      for (const i of this.data['score-partwise'][0]['part-list']['score-part'])\r\n      {\r\n         instruments.push({name: i['part-name'], instrument_id: parseInt(i['midi-instrument']['midi-program'])-1});\r\n      }\r\n      return instruments;\r\n   }\r\n   \r\n   private OnNotesLoaded(data: any)\r\n   {\r\n      this.data = data;\r\n      \r\n      this.selected_instruments = [];\r\n      this.selected_replayed_instruments = [];\r\n      var tmp = this.getInstruments();\r\n      for (var i = 0; i < tmp.length; i++)\r\n      {\r\n         this.selected_instruments.push(tmp[i].instrument_id);\r\n      }\r\n      \r\n      /* Ensure we have instruments */\r\n      this.synth.ClearAll();\r\n      this.loadInstruments(this.selected_instruments, this.OnInstrumentsLoded.bind(this, tmp));\r\n   }\r\n   \r\n   private OnInstrumentsLoded(instruments: {name: string, instrument_id: number}[]): void\r\n   {\r\n      /* Push replayed instruments */\r\n      this.selected_replayed_instruments = [];\r\n      for (var i = 0; i < instruments.length; i++)\r\n      {\r\n         this.synth.AddReplayedInstrument(instruments[i].instrument_id).then(function(r: number){this.selected_replayed_instruments.push(r)}.bind(this))\r\n      }\r\n\r\n      /* Notify end of load */\r\n      this.onLoadPromiseResolve();\r\n   }\r\n   \r\n   setTempo(t: number): void\r\n   {\r\n      this.tempo = t;\r\n   }\r\n\r\n   private resetPlayingInfo(): void\r\n   {\r\n      this.playing_info = [];\r\n      for (var i = 0; i < this.selected_instruments.length; i++)\r\n      {\r\n         this.playing_info.push({'measures_attributes': {'division': 1, 'beats': 1, 'beat_type': 1},\r\n                                 'playing_notes': {}})\r\n      }\r\n   }\r\n   \r\n   start(on_play_measure: (arg0: number) => void, on_stop: () => void): void\r\n   {\r\n      /* Start this.synth to be sure we take the audiocontext */\r\n      this.synth.start();\r\n      \r\n      /* launch the engine */\r\n      this.on_play_measure = on_play_measure;\r\n      this.on_stop = on_stop;\r\n      \r\n      if (!this.is_loaded)\r\n      {\r\n         /* Reset playing info */\r\n         this.resetPlayingInfo();\r\n         \r\n         /* Reset internal state */\r\n         this.is_playing = true;\r\n         this.is_loaded = true;\r\n      }\r\n      else\r\n      {\r\n         this.is_playing = true;\r\n      }\r\n   }\r\n   \r\n   moveToMeasure(measure_id: number): void\r\n   {\r\n      this.next_measure_to_send = measure_id-1;\r\n   }\r\n   \r\n   pause(): void\r\n   {\r\n      this.synth.stop();\r\n      this.is_playing = false;\r\n   }\r\n   \r\n   stop(): void\r\n   {\r\n      this.synth.stop();\r\n      this.is_playing = false;\r\n      this.resetPlayingInfo();\r\n      this.next_measure_to_send = 0;\r\n   }\r\n   \r\n   private ComputeNoteSymbol(pitch: any): string\r\n   {\r\n      var note_symbol = pitch.step\r\n      if (pitch.alter && (pitch.alter == '-1'))\r\n      {\r\n         note_symbol += 'b'\r\n      }\r\n      else if (pitch.alter && (pitch.alter == '-2'))\r\n      {\r\n         note_symbol += 'bb'\r\n      }\r\n      else if (pitch.alter && (pitch.alter == '1'))\r\n      {\r\n         note_symbol += '#'\r\n      }\r\n      else if (pitch.alter && (pitch.alter == '2'))\r\n      {\r\n         note_symbol += 'x'\r\n      }\r\n      note_symbol += pitch.octave;\r\n      return note_symbol;\r\n   }\r\n   \r\n   private PlayVoice(voice: number, instrument: number, note_data: any, instrument_id: number, measure_id: number): number\r\n   {\r\n      let measure = note_data[instrument_id].measure[measure_id];\r\n\r\n      var current_note_start = 0;\r\n      var last_note_duration = 0;\r\n      \r\n      /* \r\n       * Check all notes that we shall stop at begin of measure\r\n       * Note that notes that must be released in the middle of the measure will be managed after.\r\n       * Note also that this code is defensive : should never occur...\r\n       */\r\n      var notes_to_stop: string[] = [];\r\n      if (voice in this.playing_info[instrument_id].playing_notes)\r\n      {\r\n         notes_to_stop = this.playing_info[instrument_id].playing_notes[voice]\r\n      }\r\n      var remaining_notes_to_stop = [];\r\n      for (const note_to_stop of notes_to_stop)\r\n      {\r\n         /* Check if we can find it */\r\n         var shall_keep = false;\r\n         for (let entry of measure.entry)\r\n         {\r\n            if ((voice == entry.voice) &&\r\n                (entry.type == 'note') && \r\n                (entry.pitch) && \r\n                (this.ComputeNoteSymbol(entry.pitch) == note_to_stop))\r\n            {\r\n               /* Check if we shall keep it start */\r\n               if (entry.tie)\r\n               {\r\n                  shall_keep = true;\r\n               }\r\n            }                            \r\n         }\r\n         \r\n         /* Check if we keep it on */\r\n         if (shall_keep)\r\n         {\r\n            /* Push it in remaining notes */\r\n            remaining_notes_to_stop.push(note_to_stop);\r\n         }\r\n         else\r\n         {\r\n            /* Stop it */\r\n            this.synth.ReleaseNote(instrument, note_to_stop, 0);\r\n         }\r\n      }\r\n      this.playing_info[instrument_id].playing_notes[voice] = remaining_notes_to_stop;\r\n      \r\n      /* plan all notes */\r\n      for (let entry of measure.entry)\r\n      {\r\n         if (voice == entry.voice)\r\n         {\r\n            /* Check for duration */\r\n            var current_note_duration = 0;\r\n            if (entry.duration)\r\n            {\r\n               current_note_duration = (this.playing_info[instrument_id].measures_attributes.beat_type/4)*((60/this.tempo)/this.playing_info[instrument_id].measures_attributes.division)*entry.duration;\r\n            }\r\n            \r\n            if (entry.type == 'forward')\r\n            {\r\n               current_note_start += last_note_duration;\r\n               last_note_duration = current_note_duration;\r\n            }\r\n            else if (entry.type == 'note')\r\n            {\r\n               if (!current_note_duration)\r\n               {\r\n                  //TODO : ornament note -> currently, we skip them\r\n               }\r\n               else\r\n               {\r\n                  var shall_start = true;\r\n                  var shall_stop = true;\r\n                  \r\n                  var note_symbol = '_'\r\n                  if (entry.pitch)\r\n                  {\r\n                     note_symbol = this.ComputeNoteSymbol(entry.pitch);\r\n                  }\r\n                  \r\n                  if (!entry.chord)\r\n                  {\r\n                     current_note_start += last_note_duration;\r\n                     last_note_duration = current_note_duration;\r\n                  }\r\n                  \r\n                  if (entry.tie)\r\n                  {\r\n                     var is_start = false;\r\n                     for (const tie of entry.tie)\r\n                     {\r\n                        if (tie.type == 'start')\r\n                        {\r\n                           is_start = true;\r\n                        }\r\n                     }\r\n                     \r\n                     /* \r\n                      * Check if we must start it.\r\n                      * Note that, even if this is a stop, if note was not triggered, we start it if not played\r\n                      * and we will switch it off at the end of the note\r\n                      */\r\n                     if (this.playing_info[instrument_id].playing_notes[voice].includes(note_symbol))\r\n                     {\r\n                        shall_start = false;\r\n                     }\r\n                     \r\n                     /* Check if we must stop if */\r\n                     if (is_start)\r\n                     {\r\n                        shall_stop = false;\r\n                        if (!this.playing_info[instrument_id].playing_notes[voice].includes(note_symbol))\r\n                        {\r\n                           this.playing_info[instrument_id].playing_notes[voice].push(note_symbol)\r\n                        }\r\n                     }\r\n                     else\r\n                     {\r\n                        if (this.playing_info[instrument_id].playing_notes[voice].includes(note_symbol))\r\n                        {\r\n                           this.playing_info[instrument_id].playing_notes[voice].splice(this.playing_info[instrument_id].playing_notes[voice].indexOf(note_symbol), 1)\r\n                        }\r\n                     }\r\n                  }\r\n                  \r\n                  if (entry.pitch)\r\n                  {\r\n                     if (shall_start && shall_stop)\r\n                     {\r\n                        this.synth.TriggerNote(instrument, note_symbol, current_note_start, 1.0);\r\n                        this.synth.ReleaseNote(instrument, note_symbol, current_note_start+current_note_duration);\r\n                     }\r\n                     else if (shall_start)\r\n                     {\r\n                        this.synth.TriggerNote(instrument, note_symbol, current_note_start, 1.0);\r\n                     }\r\n                     else if (shall_stop)\r\n                     {\r\n                        this.synth.ReleaseNote(instrument, note_symbol, current_note_start+current_note_duration);\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         }\r\n      }\r\n      \r\n      return current_note_start + current_note_duration;\r\n   }\r\n   \r\n   private PlayInstrument(instrument: number, note_data: any, instrument_id: number, measure_id: number): number\r\n   {\r\n      let measure = note_data[instrument_id].measure[measure_id];\r\n\r\n      /* Upate attributes */\r\n      if (measure.attributes)\r\n      {\r\n         for (const attribute of measure.attributes)\r\n         {\r\n            if (attribute.divisions) {this.playing_info[instrument_id].measures_attributes.division = attribute.divisions};\r\n            if (attribute.time)\r\n            {\r\n               if (attribute.time['beat-type']) this.playing_info[instrument_id].measures_attributes.beat_type = attribute.time['beat-type'];\r\n               if (attribute.time['beats']) this.playing_info[instrument_id].measures_attributes.beats = attribute.time['beats'];\r\n            }\r\n         }\r\n      }\r\n\r\n      /* Get all voices */\r\n      var voices: number[] = []\r\n      for (let entry of measure.entry)\r\n      {\r\n         if (!voices.includes(entry.voice)) voices.push(entry.voice);\r\n      }                   \r\n      \r\n      /* Play the voices */\r\n      var measure_duration = 0;\r\n      for (let voice of voices)\r\n      {\r\n         var duration = this.PlayVoice(voice, instrument, note_data, instrument_id, measure_id);\r\n         if (measure_duration)\r\n         {\r\n            if (duration > measure_duration) measure_duration = duration;\r\n         }\r\n         else\r\n         {\r\n            measure_duration = duration;\r\n         }\r\n      }\r\n      return measure_duration;\r\n   }\r\n   \r\n   private TriggerOnMeasure(measure_id: number): void\r\n   {\r\n      this.on_play_measure(measure_id);\r\n   }\r\n   \r\n   private PlayMeasure(): void\r\n   {\r\n      /* play the instruments */\r\n      var measure_duration = 0;\r\n      for (var id = 0; id < this.selected_instruments.length; id++)\r\n      {\r\n         var d = this.PlayInstrument(this.selected_replayed_instruments[id], this.data['score-partwise'][0].part, id, this.next_measure_to_send);\r\n         if (measure_duration)\r\n         {\r\n            if (measure_duration < d) measure_duration = d;\r\n         }\r\n         else\r\n         {\r\n            measure_duration = d\r\n         }\r\n      }\r\n      \r\n      /* Confirm the sending of the measure */\r\n      var measure_start_time = this.synth.setFeededWithDuration(measure_duration)\r\n      \r\n      /* Send callback */\r\n      var measure_played = this.next_measure_to_send+1;\r\n      setTimeout(this.TriggerOnMeasure.bind(this, measure_played), (measure_start_time-this.synth.now())*1000);\r\n\r\n      /* Check if we still have something to play */\r\n      if ((this.next_measure_to_send < (this.data['score-partwise'][0].part[0].measure.length-1)))\r\n      {\r\n         /* Update internal data */\r\n         this.next_measure_to_send++;\r\n      }\r\n      else\r\n      {\r\n         /* stop the play */\r\n         this.is_playing = false;\r\n         this.resetPlayingInfo();\r\n         this.next_measure_to_send = 0;\r\n         \r\n         /* Send the callback */\r\n         setTimeout(this.on_stop, (measure_start_time+measure_duration-this.synth.now())*1000);\r\n      }\r\n   }\r\n   \r\n   private getNotes(): {[index: number]:{[index: string]:boolean}}\r\n   {\r\n      var notes:{[index: number]:{[index: string]:boolean}} = {}\r\n      var instrument = 0;\r\n      for (let part of this.data['score-partwise'][0].part)\r\n      {\r\n         for (let measure of part.measure)\r\n         {\r\n            for (let entry of measure.entry)\r\n            {\r\n               if ((entry.type == 'note') && \r\n                   (entry.pitch))\r\n               {\r\n                  var note = this.ComputeNoteSymbol(entry.pitch);\r\n                  var i = this.selected_instruments[instrument]\r\n                  \r\n                  notes[i] = notes[i] || {};\r\n                  notes[i][note] = true;\r\n               }\r\n            }\r\n         }\r\n         instrument++;\r\n      }\r\n      return notes;\r\n   }\r\n   \r\n   private OnCyclic(): void\r\n   {\r\n      if (this.is_playing && \r\n          this.synth.checkShallFeed())\r\n      {\r\n         this.PlayMeasure();\r\n      }\r\n   }\r\n   \r\n   private loadNotes(mxl: string): void\r\n   {\r\n      /* Extract XML */\r\n      this.extractXML(mxl)\r\n   }\r\n   \r\n   private OnXMLExtracted(xml: string): void\r\n   {\r\n      var attributes_filter:{[index: string]:{[index: string]:string}} = \r\n         {'part': {'id': 'id'},\r\n          'tie': {'type': 'type'}}\r\n      var array_nodes: string[] =\r\n         ['score-partwise', 'score-part', 'part', 'measure', 'note', 'attributes', 'forward', 'tie']\r\n      var children_filter: {[index: string]:any} = \r\n         {'root': {'score-partwise': {}},\r\n          'score-partwise': {'part-list': {}, 'part': {}},\r\n          'part-list': {'score-part': {}},\r\n          'score-part': {'part-name': {}, 'midi-instrument': {}},\r\n          'part-name': {'@text': {}},\r\n          'midi-instrument': {'midi-program': {}},\r\n          'midi-program': {'@text': {}},\r\n          'part': {'measure': {}},\r\n          'measure': {'attributes': {}, 'note': {'export_name': 'entry', 'attributes': [{'name': 'type', 'value': 'note'}]}, 'forward': {'export_name': 'entry', 'attributes': [{'name': 'type', 'value': 'forward'}]}},\r\n          'attributes': {'divisions': {}, 'time': {}, 'transpose': {}},\r\n          'divisions': {'@text': {}},\r\n          'time': {'beats': {}, 'beat-type': {}},\r\n          'beats': {'@text': {}},\r\n          'beat_type': {'@text': {}},\r\n          'transpose': {'diatonic': {}, 'chromatic': {}, 'octave-change': {}},\r\n          'diatonic': {'@text': {}},\r\n          'chromatic': {'@text': {}},\r\n          'octave-change': {'@text': {}},\r\n          'note': {'rest': {}, 'pitch': {}, 'duration': {}, 'tie': {}, 'chord': {}, 'voice': {}},\r\n          'rest': {},\r\n          'pitch': {'step': {}, 'octave': {}, 'alter': {}},\r\n          'step': {'@text': {}},\r\n          'octave': {'@text': {}},\r\n          'duration': {'@text': {}},\r\n          'tie': {},\r\n          'forward': {'duration': {}, 'voice': {}}}\r\n\r\n      function xmlToJson(xml: any, node_parent: string)\r\n      {\r\n         // Create the return object\r\n         var obj: any = {};\r\n\r\n         if (xml.nodeType == 1) \r\n         {\r\n            for (var j = 0; j < xml.attributes.length; j++)\r\n            {\r\n               var attribute = xml.attributes.item(j);\r\n               if (attributes_filter[node_parent] && attributes_filter[node_parent][attribute.nodeName])\r\n               {\r\n                  obj[attributes_filter[node_parent][attribute.nodeName]] = attribute.nodeValue;\r\n               }\r\n            }\r\n         }\r\n         else if (xml.nodeType == 3)\r\n         {\r\n            return false;\r\n         }\r\n\r\n         var textNodes: any = [].slice.call(xml.childNodes).filter(function(node: any)\r\n         {\r\n            return node.nodeType === 3;\r\n         });\r\n         if (xml.hasChildNodes() && xml.childNodes.length === textNodes.length)\r\n         {\r\n            obj = [].slice.call(xml.childNodes).reduce(function(text: string, node: any)\r\n            {\r\n               return text + node.nodeValue;\r\n            }, \"\");\r\n         }\r\n         else if (xml.hasChildNodes())\r\n         {\r\n            for (var i = 0; i < xml.children.length; i++)\r\n            {\r\n               \r\n               var item = xml.children.item(i);\r\n               var nodeName = item.nodeName;\r\n               if (children_filter[node_parent] && (nodeName in children_filter[node_parent]))\r\n               {\r\n                  var export_name = nodeName\r\n                  if (children_filter[node_parent][nodeName]['export_name'])\r\n                  {\r\n                     export_name = children_filter[node_parent][nodeName]['export_name']\r\n                  }\r\n\r\n                  var value = xmlToJson(item, nodeName)\r\n                  if (children_filter[node_parent][nodeName]['attributes'])\r\n                  {\r\n                     for (const a of children_filter[node_parent][nodeName]['attributes'])\r\n                     {\r\n                        value[a.name] = a.value;\r\n                     }\r\n                  }\r\n                  \r\n                  if (typeof obj[export_name] == \"undefined\")\r\n                  {\r\n                     if (array_nodes.includes(nodeName))\r\n                     {\r\n                        obj[export_name] = [value];\r\n                     }\r\n                     else\r\n                     {\r\n                        obj[export_name] = value;\r\n                     }\r\n                  }\r\n                  else\r\n                  {\r\n                     if (typeof obj[export_name].push == \"undefined\")\r\n                     {\r\n                        var old = obj[nodeName];\r\n                        obj[export_name] = [];\r\n                        obj[export_name].push(old);\r\n                     }\r\n                     \r\n                     obj[export_name].push(value);\r\n                  }\r\n               }\r\n            }\r\n         }\r\n         return obj;\r\n      }\r\n      \r\n      /* Perform a filtered conversion */\r\n      var json_data = xmlToJson(new DOMParser().parseFromString(xml, 'text/xml'), 'root');\r\n      \r\n      /* Extract parts */\r\n      this.OnNotesLoaded(json_data);\r\n   }\r\n   \r\n   private OnXMLManifestLoaded(zip: any, data: string): void\r\n   {\r\n      /* Retrieve main file */  \r\n      var main_file = (new DOMParser()).parseFromString(data, \"text/xml\").getElementsByTagName('rootfile')[0].getAttribute('full-path') ;\r\n\r\n      /* Extract it */\r\n      zip.file(main_file).async(\"string\").then(this.OnXMLExtracted.bind(this));\r\n   }\r\n   \r\n   private OnXMLLoaded(zip: any): void\r\n   {\r\n      zip.file(\"META-INF/container.xml\").async(\"string\").then(this.OnXMLManifestLoaded.bind(this, zip));\r\n   }\r\n   \r\n   private extractXML(mxl: string): void\r\n   {\r\n      /* Unzip */\r\n      var z = new JSZip();\r\n      z.loadAsync(mxl).then(this.OnXMLLoaded.bind(this));\r\n   }\r\n}","declare global {\r\n  interface Window {\r\n    webkitAudioContext: any;\r\n    MIDI: any;\r\n  }\r\n  function requirejs(arg0: string[], arg1: Function): void\r\n  function NoteParser(): any\r\n  function requirejs(arg_: string[], arg1: () => void): void\r\n}\r\n\r\nexport class Synthetizer\r\n{\r\n   private is_loaded: boolean;\r\n   private is_cleanup: boolean;\r\n   private instruments: number[];\r\n   private note_parser: any;\r\n   \r\n   private context: any;\r\n   \r\n   private playing: boolean;\r\n   private shall_feed: boolean;\r\n   private last_sent_finish_time: number;\r\n   private periodic_function: number;\r\n   private in_sending: boolean;\r\n   private feeded: boolean;\r\n   private duration: number;\r\n   \r\n   private last_promise_id: number;\r\n   private promises:{[index: number]:(value: number) => void};\r\n   \r\n   private worker: any;\r\n   \r\n   private onLoadPromise: any;\r\n   \r\n   private sample_base_url: string;\r\n   \r\n   constructor(sample_base_url: string=\"https://gleitz.github.io/midi-js-soundfonts/MusyngKite/\")\r\n   {\r\n      /* Determine location of worker */   \r\n      var worker_path = 'music-xml-player-worker.min.js';\r\n      var scripts = document.getElementsByTagName(\"script\");\r\n      for (var i = 0; i < scripts.length; i++)\r\n      {\r\n         var src = scripts[i].getAttribute('src');\r\n         if (src.indexOf(\"?\") >= 0)\r\n         {\r\n            src = src.substring(0, src.indexOf(\"?\"));\r\n         }\r\n\r\n         if (src.endsWith('music-xml-player.js'))\r\n         {\r\n            worker_path = src.slice(0, src.lastIndexOf('/'))+'/music-xml-player-worker.js';\r\n         }\r\n         else if (src.endsWith('music-xml-player.min.js'))\r\n         {\r\n            worker_path = src.slice(0, src.lastIndexOf('/'))+'/music-xml-player-worker.min.js';\r\n         }\r\n      }\r\n\r\n      /* Set internal data  */\r\n      this.is_loaded = false;\r\n      this.is_cleanup = false;\r\n      this.instruments = [];\r\n      this.note_parser = NoteParser();\r\n      \r\n      this.context = new (window.AudioContext || window.webkitAudioContext)();\r\n      \r\n      this.playing = false;\r\n      this.shall_feed = false;\r\n      this.last_sent_finish_time = 0;\r\n      this.periodic_function = setInterval(this.onCyclic.bind(this), 100);\r\n      this.in_sending = false;\r\n\r\n      this.feeded = false;\r\n      this.duration = 0.5;\r\n      \r\n      this.sample_base_url = sample_base_url;\r\n\r\n      /* Set queue of promises under wait */\r\n      this.last_promise_id = 0;\r\n      this.promises = {};\r\n      \r\n      /* Initialise workers */\r\n      this.worker = new Worker(worker_path);\r\n      this.onLoadPromise = new Promise(this.OnWorkerInitialised.bind(this));\r\n   }\r\n   \r\n   cleanup(): void\r\n   {\r\n      if (!this.is_cleanup)\r\n      {\r\n         this.is_cleanup = true;\r\n         clearInterval(this.periodic_function);\r\n         this.worker.terminate();\r\n         this.context.close()\r\n      }\r\n   }\r\n   \r\n   private OnWorkerInitialised(resolve: (value: boolean) => void)\r\n   {\r\n      this.worker.onmessage = this.ManageWorkerMessage.bind(this, resolve);\r\n   }\r\n   \r\n   private ManageWorkerMessage(resolve: (value: boolean) => void, e: any)\r\n   {\r\n      if (e.data.type == 'initialised')\r\n      {\r\n         this.is_loaded = true;\r\n         resolve(true);\r\n      }\r\n      else if (this.promises.hasOwnProperty(e.data.promise))\r\n      {\r\n         this.promises[e.data.promise](e.data.result);\r\n         delete this.promises[e.data.promise];\r\n      }\r\n   }\r\n   \r\n   waitReady(callback: Function): void\r\n   {\r\n      this.onLoadPromise.then(callback);\r\n   }\r\n   \r\n   loadInstruments(instruments: number[], used_notes: {[index: number]:{[index: string]:boolean}}, callback: () => void): void\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      /* Check which instruments have not been loaded */\r\n      var instruments_to_load: number[] = [];\r\n      var instruments_url: string[] = []\r\n      for (const i of instruments)\r\n      {\r\n         if ((!this.instruments.includes(i)) && (!instruments_to_load.includes(i)))\r\n         {\r\n            instruments_to_load.push(i);\r\n            instruments_url.push(this.sample_base_url+this.midiInstrumentsNames[i]+\"-mp3.js\")\r\n         }\r\n      }\r\n      \r\n      /* Check if we have at least one instrument to load */\r\n      if (instruments_to_load.length <= 0)\r\n      {\r\n         callback();\r\n         return\r\n      }\r\n      \r\n      /* Format urls */\r\n      requirejs(instruments_url, this.OnLoadInstruments.bind(this, instruments_to_load, used_notes, callback));\r\n   }\r\n   \r\n   private OnLoadInstruments(instruments_to_load: number[], used_notes: {[index: number]:{[index: string]:boolean}}, callback: () => void) \r\n   {\r\n      var promises = [];\r\n      \r\n      window.MIDI = window.MIDI || {};\r\n      window.MIDI.parsed = window.MIDI.parsed || {};\r\n      \r\n      /* Perform full conversion of inputs */\r\n      for (let instrument of instruments_to_load)\r\n      {\r\n         var filtered_notes = [];\r\n         var tmp = Object.keys(used_notes[instrument])\r\n         for (const t of tmp)\r\n         {\r\n            filtered_notes.push(this.note_parser.convert(t));\r\n         }\r\n\r\n         this.instruments.push(instrument);\r\n         window.MIDI.parsed[this.midiInstrumentsNames[instrument]] = window.MIDI.parsed[this.midiInstrumentsNames[instrument]] || {};\r\n         \r\n         for (let note in window.MIDI.Soundfont[this.midiInstrumentsNames[instrument]])\r\n         {\r\n            if (filtered_notes.includes(this.note_parser.convert(note)))\r\n            {\r\n               promises.push(this.OnLoadNote(window.MIDI.Soundfont[this.midiInstrumentsNames[instrument]][note], instrument, note))\r\n            }\r\n         }\r\n      }\r\n\r\n      /* Wait for all promises to resolve */\r\n      Promise.all(promises).then(callback);\r\n   }\r\n   \r\n   AddReplayedInstrument(instrument_id: number): Promise<number>\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      return this.AddReplayedInstrumentToWorker(instrument_id);\r\n   }\r\n   \r\n   ClearAll(): Promise<number>\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      return this.ClearAllToWorker();\r\n   }\r\n   \r\n   SetReplayedInstrumentVolume(replayed_instrument: number, volume: number): Promise<number>\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      return this.SetReplayedInstrumentVolumeToWorker(replayed_instrument, volume);\r\n   }\r\n   \r\n   SetReplayedInstrumentInstrument(replayed_instrument: number, instrument: number): Promise<number>\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      return this.SetReplayedInstrumentInstrumentToWorker(replayed_instrument, instrument);\r\n   }\r\n   \r\n   TriggerNote(replayed_instrument: number, note: string, offset: number, volume: number): Promise<number>\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      return this.TriggerNoteToWorker(replayed_instrument, this.note_parser.convert(note), Math.floor(offset*this.context.sampleRate), volume);\r\n   }\r\n   \r\n   ReleaseNote(replayed_instrument: number, note: string, offset: number): Promise<number>\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      return this.ReleaseNoteToWorker(replayed_instrument, this.note_parser.convert(note), Math.floor(offset*this.context.sampleRate));\r\n   }\r\n   \r\n   ReleaseAllNotes(replayed_instrument: number): Promise<number>\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      return this.ReleaseAllNotes(replayed_instrument);\r\n   }\r\n\r\n   start(): void\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      this.playing = true;\r\n      this.shall_feed = true;\r\n      this.feeded = false;\r\n      this.duration = 0.5;\r\n      this.last_sent_finish_time = this.context.currentTime;\r\n      this.send_next_sample();\r\n   }\r\n   \r\n   stop(): void\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      this.playing = false;\r\n   }\r\n   \r\n   checkShallFeed(): boolean\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      if (this.shall_feed)\r\n      {\r\n         this.shall_feed = false;\r\n         return true;\r\n      }\r\n      return false;\r\n   }\r\n   \r\n   setFeededWithDuration(duration: number): number\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      this.duration = duration;\r\n      this.feeded = true;\r\n      return this.last_sent_finish_time;\r\n   }\r\n   \r\n   now(): number\r\n   {\r\n      /* Check that we are initialised */\r\n      if (!this.is_loaded) throw new Error('Synthetiser not initialised. Please call waitReady prior to any other call !');\r\n         \r\n      return this.context.currentTime;\r\n   }\r\n\r\n   private invokeWorkerCommand(name: string, args: any): Promise<number>\r\n   {\r\n      return new Promise<number>(this.InvokeWorkerCommandPromise.bind(this, name, args))\r\n   }\r\n   private InvokeWorkerCommandPromise(name: string, args: any, resolve: (value: number) => void): void\r\n   {\r\n      this.last_promise_id++;\r\n      this.promises[this.last_promise_id] = resolve;\r\n      this.worker.postMessage({'promise': this.last_promise_id,\r\n                               'type': name,\r\n                               'args': args});\r\n   }\r\n   \r\n   private load_note(instrument_id: number, note: string, sample_rate: number, length: number, channel_1_data: ArrayBuffer, channel_2_data: ArrayBuffer)\r\n   {\r\n      return new Promise<number>(this.load_note_Promise.bind(this, instrument_id, note, sample_rate, length, channel_1_data, channel_2_data))\r\n   }\r\n   private load_note_Promise(instrument_id: number, note: string, sample_rate: number, length: number, channel_1_data: ArrayBuffer, channel_2_data: ArrayBuffer, resolve: (value: number) => void)\r\n   {\r\n      this.last_promise_id++;\r\n      this.promises[this.last_promise_id] = resolve;\r\n      this.worker.postMessage({'promise': this.last_promise_id,\r\n                               'type': 'load_note',\r\n                               'args': [instrument_id, note, sample_rate, length, channel_1_data, channel_2_data]},\r\n                              [channel_1_data, channel_2_data]);\r\n   }\r\n\r\n   private AddReplayedInstrumentToWorker(instrument_id: number) {return this.invokeWorkerCommand('AddReplayedInstrument', [instrument_id])}\r\n   private ClearAllToWorker() {return this.invokeWorkerCommand('ClearAll', [])}\r\n\r\n   private SetReplayedInstrumentVolumeToWorker(replayed_instrument: number, volume: number) {return this.invokeWorkerCommand('SetReplayedInstrumentVolume', [replayed_instrument, volume])}\r\n   private SetReplayedInstrumentInstrumentToWorker(replayed_instrument: number, instrument: number) {return this.invokeWorkerCommand('SetReplayedInstrumentInstrument', [replayed_instrument, instrument])}\r\n\r\n   private TriggerNoteToWorker(replayed_instrument: number, note: number, offset: number, volume: number) {return this.invokeWorkerCommand('TriggerNote', [replayed_instrument, note, offset, volume])}\r\n   private ReleaseNoteToWorker(replayed_instrument: number, note: number, offset: number) {return this.invokeWorkerCommand('ReleaseNote', [replayed_instrument, note, offset])}\r\n\r\n   private SampleDataToWorker(time: number) {return this.invokeWorkerCommand('SampleData', [time])}\r\n\r\n   private midiInstrumentsNames : string[] =\r\n      [\"acoustic_grand_piano\",\r\n       \"bright_acoustic_piano\",\r\n       \"electric_grand_piano\",\r\n       \"honkytonk_piano\",\r\n       \"electric_piano_1\",\r\n       \"electric_piano_2\",\r\n       \"harpsichord\",\r\n       \"clavinet\",\r\n       \"celesta\",\r\n       \"glockenspiel\",\r\n       \"music_box\",\r\n       \"vibraphone\",\r\n       \"marimba\",\r\n       \"xylophone\",\r\n       \"tubular_bells\",\r\n       \"dulcimer\",\r\n       \"drawbar_organ\",\r\n       \"percussive_organ\",\r\n       \"rock_organ\",\r\n       \"church_organ\",\r\n       \"reed_organ\",\r\n       \"accordion\",\r\n       \"harmonica\",\r\n       \"tango_accordion\",\r\n       \"acoustic_guitar_nylon\",\r\n       \"acoustic_guitar_steel\",\r\n       \"electric_guitar_jazz\",\r\n       \"electric_guitar_clean\",\r\n       \"electric_guitar_muted\",\r\n       \"overdriven_guitar\",\r\n       \"distortion_guitar\",\r\n       \"guitar_harmonics\",\r\n       \"acoustic_bass\",\r\n       \"electric_bass_finger\",\r\n       \"electric_bass_pick\",\r\n       \"fretless_bass\",\r\n       \"slap_bass_1\",\r\n       \"slap_bass_2\",\r\n       \"synth_bass_1\",\r\n       \"synth_bass_2\",\r\n       \"violin\",\r\n       \"viola\",\r\n       \"cello\",\r\n       \"contrabass\",\r\n       \"tremolo_strings\",\r\n       \"pizzicato_strings\",\r\n       \"orchestral_harp\",\r\n       \"timpani\",\r\n       \"string_ensemble_1\",\r\n       \"string_ensemble_2\",\r\n       \"synth_strings_1\",\r\n       \"synth_strings_2\",\r\n       \"choir_aahs\",\r\n       \"voice_oohs\",\r\n       \"synth_choir\",\r\n       \"orchestra_hit\",\r\n       \"trumpet\",\r\n       \"trombone\",\r\n       \"tuba\",\r\n       \"muted_trumpet\",\r\n       \"french_horn\",\r\n       \"brass_section\",\r\n       \"synth_brass_1\",\r\n       \"synth_brass_2\",\r\n       \"soprano_sax\",\r\n       \"alto_sax\",\r\n       \"tenor_sax\",\r\n       \"baritone_sax\",\r\n       \"oboe\",\r\n       \"english_horn\",\r\n       \"bassoon\",\r\n       \"clarinet\",\r\n       \"piccolo\",\r\n       \"flute\",\r\n       \"recorder\",\r\n       \"pan_flute\",\r\n       \"blown_bottle\",\r\n       \"shakuhachi\",\r\n       \"whistle\",\r\n       \"ocarina\",\r\n       \"lead_1_square\",\r\n       \"lead_2_sawtooth\",\r\n       \"lead_3_calliope\",\r\n       \"lead_4_chiff\",\r\n       \"lead_5_charang\",\r\n       \"lead_6_voice\",\r\n       \"lead_7_fifths\",\r\n       \"lead_8_basslead\",\r\n       \"pad_1_new_age\",\r\n       \"pad_2_warm\",\r\n       \"pad_3_polysynth\",\r\n       \"pad_4_choir\",\r\n       \"pad_5_bowed\",\r\n       \"pad_6_metallic\",\r\n       \"pad_7_halo\",\r\n       \"pad_8_sweep\",\r\n       \"fx_1_rain\",\r\n       \"fx_2_soundtrack\",\r\n       \"fx_3_crystal\",\r\n       \"fx_4_atmosphere\",\r\n       \"fx_5_brightness\",\r\n       \"fx_6_goblins\",\r\n       \"fx_7_echoes\",\r\n       \"fx_8_scifi\",\r\n       \"sitar\",\r\n       \"banjo\",\r\n       \"shamisen\",\r\n       \"koto\",\r\n       \"kalimba\",\r\n       \"bagpipe\",\r\n       \"fiddle\",\r\n       \"shanai\",\r\n       \"tinkle_bell\",\r\n       \"agogo\",\r\n       \"steel_drums\",\r\n       \"woodblock\",\r\n       \"taiko_drum\",\r\n       \"melodic_tom\",\r\n       \"synth_drum\",\r\n       \"reverse_cymbal\",\r\n       \"guitar_fret_noise\",\r\n       \"breath_noise\",\r\n       \"seashore\",\r\n       \"bird_tweet\",\r\n       \"telephone_ring\",\r\n       \"helicopter\",\r\n       \"applause\",\r\n       \"gunshot\"]\r\n \r\n   private base64ToArrayBuffer(base64: string) \r\n   {\r\n      var binary_string = window.atob(base64.slice(base64.lastIndexOf(',') + 1));\r\n      var len = binary_string.length;\r\n      var bytes = new Uint8Array(len);\r\n      for (var i = 0; i < len; i++)\r\n      {\r\n         bytes[i] = binary_string.charCodeAt(i);\r\n      }\r\n      return bytes.buffer;\r\n   }\r\n   \r\n   private LoadNote(instrument: number, note: string, resolve: () => void, d: AudioBuffer)\r\n   {\r\n      /* Extract data */\r\n      var channel_1: Float32Array = d.getChannelData(0);\r\n      var channel_2: Float32Array = d.getChannelData(1);\r\n      \r\n      /* Convert to ArrayBuffer */\r\n      var channel_1_buffer = new ArrayBuffer(4*channel_1.length);\r\n      var channel_2_buffer = new ArrayBuffer(4*channel_2.length);\r\n      \r\n      var channel_1_buffer_view = new Float32Array(channel_1_buffer);\r\n      var channel_2_buffer_view = new Float32Array(channel_2_buffer);\r\n      \r\n      for (var i = 0; i < channel_1.length; i++)\r\n      {\r\n         channel_1_buffer_view[i] = channel_1[i];\r\n         channel_2_buffer_view[i] = channel_2[i];\r\n      }\r\n   \r\n      this.internal_load_note(instrument, this.note_parser.convert(note), d.sampleRate, channel_1.length, channel_1_buffer, channel_2_buffer).then(resolve)\r\n   }\r\n   private OnDecodeNote(b64_data: string,  instrument: number, note: string, resolve: () => void)\r\n   {\r\n      this.context.decodeAudioData(this.base64ToArrayBuffer(b64_data), this.LoadNote.bind(this, instrument, note, resolve));\r\n   }\r\n   private OnLoadNote(b64_data: string, instrument: number, note: string)\r\n   {\r\n      return new Promise(this.OnDecodeNote.bind(this, b64_data, instrument, note));\r\n   }\r\n   \r\n   private internal_load_note(instrument_id: number, note: string, sample_rate: number, nb_samples: number, channel_1_data: ArrayBuffer, channel_2_data: ArrayBuffer)\r\n   {\r\n      return this.load_note(instrument_id, note, sample_rate, nb_samples, channel_1_data, channel_2_data);\r\n   }\r\n   \r\n   private SampleData(time: number)\r\n   {\r\n      /* Compute number of elements */\r\n      var nb_samples = Math.floor(this.context.sampleRate*time);\r\n      \r\n      /* Perform the call */\r\n      return this.SampleDataToWorker(nb_samples);\r\n   }\r\n   \r\n   private SendDataToSoundCard(data: [Float32Array,Float32Array]): void\r\n   {\r\n      /* Convert data from ArrayBuffer to Float32Array */\r\n      var data_buffer_1 = new Float32Array(data[0]);\r\n      var data_buffer_2 = new Float32Array(data[1]);\r\n\r\n      /* Create the audio buffer */\r\n      var buffer = this.context.createBuffer(2, this.duration*this.context.sampleRate, this.context.sampleRate);\r\n      \r\n      this.shall_feed = true;\r\n      \r\n      /* feed in buffer */\r\n      var b1 = buffer.getChannelData(0);\r\n      var b2 = buffer.getChannelData(1);\r\n      \r\n      for (var i = 0; i < buffer.length; i++)\r\n      {\r\n         b1[i] = data_buffer_1[i];\r\n         b2[i] = data_buffer_2[i];\r\n      }\r\n      \r\n      /* Send it to sound card */\r\n      var source = this.context.createBufferSource();\r\n      source.buffer = buffer;\r\n      source.connect(this.context.destination);\r\n      source.start(this.last_sent_finish_time);\r\n      \r\n      /* Update local time */\r\n      this.last_sent_finish_time += this.duration;\r\n      this.in_sending = false;\r\n   }\r\n   \r\n   private send_next_sample()\r\n   {\r\n      this.in_sending = true;\r\n      \r\n      /* Check if we have data */\r\n      if (this.feeded)\r\n      {\r\n         /* Sample next duration */\r\n         this.SampleData(this.duration).then(this.SendDataToSoundCard.bind(this))\r\n      }\r\n      else\r\n      {\r\n         this.SendDataToSoundCard([new Float32Array(this.duration*this.context.sampleRate),\r\n                                   new Float32Array(this.duration*this.context.sampleRate)]);\r\n      }\r\n   }\r\n   \r\n   private onCyclic()\r\n   {\r\n      /* Run only of we are playing */\r\n      if (!this.playing) return;\r\n      \r\n      /* Check that we are not in sending stuff */\r\n      if (this.in_sending) return;\r\n      \r\n      /* We send next sample only half second before expiration */\r\n      if ((this.last_sent_finish_time-1.0) <= this.context.currentTime)\r\n      {\r\n         this.send_next_sample();\r\n      }\r\n   }\r\n}\r\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// startup\n// Load entry module and return exports\n// This entry module is referenced by other modules so it can't be inlined\n__webpack_require__(13);\nvar __webpack_exports__ = __webpack_require__(555);\n"],"sourceRoot":""}